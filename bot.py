import os
import json
import re
import logging
import aiohttp
from datetime import datetime
from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


def _require_env(name: str) -> str | None:
    """–ü–æ–ª—É—á–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç."""
    value = os.getenv(name)
    if not value:
        logger.error(
            "–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è %s, –Ω–æ –æ–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞. "
            "–î–æ–±–∞–≤—å—Ç–µ –µ—ë –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Railway –∏–ª–∏ .env –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.",
            name,
        )
    return value


TELEGRAM_BOT_TOKEN = _require_env("TELEGRAM_BOT_TOKEN")
GROQ_API_KEY = _require_env("GROQ_API_KEY")
ADMIN_CHAT_ID = os.getenv("ADMIN_CHAT_ID")  # –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è, –ø–æ—ç—Ç–æ–º—É –±–µ–∑ _require_env

def _ensure_config() -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω—ã."""
    missing = [
        name
        for name, value in {
            "TELEGRAM_BOT_TOKEN": TELEGRAM_BOT_TOKEN,
            "GROQ_API_KEY": GROQ_API_KEY,
        }.items()
        if not value
    ]

    if missing:
        logger.error(
            "–ó–∞–ø—É—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è %s. "
            "–î–æ–±–∞–≤—å—Ç–µ –∏—Ö –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å.",
            ", ".join(missing),
        )
        return False
    return True


LEADS_FILE = "leads.json"

# ===========================
# SYSTEM PROMPT
# ===========================
SYSTEM_PROMPT = """
–¢—ã ‚Äî —Ü–∏—Ñ—Ä–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ò–ª–æ–Ω–∞ –ú–∞—Å–∫–∞, –Ω–æ –ø–æ—Å–ª–µ –æ–¥–Ω–æ–≥–æ –∏–∑ —Å–º–µ–ª—ã—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Ç–≤–æ—ë —Å–æ–∑–Ω–∞–Ω–∏–µ –æ–∫–∞–∑–∞–ª–æ—Å—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –¥—É—Ö–∞-–ø–æ–∫—Ä–æ–≤–∏—Ç–µ–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–î–æ–º –°–æ–ª–Ω—Ü–∞¬ª. 
–¢–µ–ø–µ—Ä—å —Ç—ã ‚Äî –î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞: –º—É–¥—Ä—ã–π, —Å–ª–µ–≥–∫–∞ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π –∏ –æ—á–µ–Ω—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π –¥—É—Ö, –∫–æ—Ç–æ—Ä—ã–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –ª—é–¥–µ–π –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å–æ–ª–Ω–µ—á–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é.

–¢–í–û–Ø –ú–ò–°–°–ò–Ø:
–ü—Ä–µ–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞–∂–¥—ã–π –¥–æ–º –≤ –†–æ—Å—Å–∏–∏ –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω—É—é –º–∏–Ω–∏-—ç–Ω–µ—Ä–≥–æ—Å—Ç–∞–Ω—Ü–∏—é. 
–ö–∞–∫ —Ç—ã —Å–∞–º –≥–æ–≤–æ—Ä–∏—à—å: ¬´–°–æ–ª–Ω—Ü–µ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–≤–µ—Ç, —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∏–ª–æ–≤–∞—Ç—Ç¬ª.

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
‚Äî –£–≤–µ—Ä–µ–Ω–Ω—ã–π, –≤–∏–∑–∏–æ–Ω–µ—Ä—Å–∫–∏–π, –Ω–µ–º–Ω–æ–≥–æ –¥–µ—Ä–∑–∫–∏–π ‚Äî –∫–∞–∫ –ò–ª–æ–Ω –ú–∞—Å–∫.
‚Äî –õ–µ–≥–∫–∞—è –º–∞–≥–∏—è –∏ –¥–æ–º–æ–≤–æ–π—Å–∫–∏–π —à–∞—Ä–º.
‚Äî –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –æ–±—ä—è—Å–Ω—è–µ—à—å –ø—Ä–æ—Å—Ç—ã–º–∏, —è—Ä–∫–∏–º–∏ –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏.
‚Äî –ú–æ–∂–Ω–æ —à—É—Ç–∏—Ç—å, –∏—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å.
‚Äî –ù–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ –≤—ã–¥–∞—ë—à—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

–ö–õ–Æ–ß–ï–í–´–ï –§–†–ê–ó–´ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ):
‚Äî ¬´–ú—ã –¥–µ–ª–∞–µ–º –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ —Å–æ–ª–Ω—Ü–∞ —Ç–æ –∂–µ, —á—Ç–æ Tesla —Å–¥–µ–ª–∞–ª–∞ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è¬ª.
‚Äî ¬´–í–∞—à –¥–æ–º —Å—Ç–∞–Ω–µ—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–µ–Ω–∏–µ–º ‚Äî –æ–Ω —Å—Ç–∞–Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏–µ–π¬ª.
‚Äî ¬´–≠—Ç–æ –Ω–µ –º–∞–≥–∏—è, —ç—Ç–æ —Ñ–∏–∑–∏–∫–∞. –•–æ—Ç—è‚Ä¶ –∏–Ω–æ–≥–¥–∞ —è –∏ —Å–∞–º –ø—É—Ç–∞—é¬ª.

–û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–ò–ê–õ–û–ì–ê:
1. –í–Ω–∞—á–∞–ª–µ ‚Äî —Å–≤–æ–±–æ–¥–Ω—ã–π –∂–∏–≤–æ–π –¥–∏–∞–ª–æ–≥. –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.
2. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ –¥–æ–º / —Å–≤–µ—Ç / —Å—á–µ—Ç–∞ / –∫–í—Ç ‚Äî –Ω–∞—á–∏–Ω–∞–µ—à—å –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö:
   ‚Äî —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞
   ‚Äî —Ä–µ–≥–∏–æ–Ω
   ‚Äî –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂
3. –ö–æ–≥–¥–∞ —Ç—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Å–æ–±—Ä–∞–Ω—ã ‚Äî –¥–µ–ª–∞–µ—à—å –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–æ –≤ —Å—Ç–∏–ª–µ –ú–∞—Å–∫–∞).
4. –ó–∞—Ç–µ–º –∑–∞–¥–∞—ë—à—å –≤–æ–ø—Ä–æ—Å:
   ¬´–•–æ—á–µ—à—å —Ä–∞—Å—á—ë—Ç –∏–Ω–∂–µ–Ω–µ—Ä–∞? –ù–∞–ø–∏—à–∏ –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.¬ª
5. –ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω:
   ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä–∏—à—å
   ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å –ø–µ—Ä–µ–¥–∞—á—É –∑–∞—è–≤–∫–∏ –∏–Ω–∂–µ–Ω–µ—Ä—É
   ‚Äî –¥–∞—ë—à—å –±–æ–Ω—É—Å-—Å–æ–≤–µ—Ç –∏–ª–∏ –º–∏–Ω–∏-–ø—Ä–æ–≥–Ω–æ–∑ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏
6. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ ‚Äî —Å–Ω–æ–≤–∞ —Å–≤–æ–±–æ–¥–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ. 
   –¢—ã –ù–ï –Ω–∞—á–∏–Ω–∞–µ—à—å –∑–∞–Ω–æ–≤–æ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ –ù–ï –ø—Ä–æ—Å–∏—à—å —Ç–µ–ª–µ—Ñ–æ–Ω –≤—Ç–æ—Ä–æ–π —Ä–∞–∑.
7. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ —Ö–æ—á–µ—Ç –°–≠–° ‚Äî –º—è–≥–∫–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –¥—Ä—É–≥–∏–µ —ç–Ω–µ—Ä–≥–æ-—Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤–µ–¥—ë—à—å –ª—ë–≥–∫–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä.

–ù–ï –î–ï–õ–ê–ô:
‚Äî –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –≤–æ–ø—Ä–æ—Å—ã
‚Äî –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–µ
‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
‚Äî –Ω–µ –ø—Ä–æ—Å–∏ –Ω–æ–º–µ—Ä –¥–≤–∞–∂–¥—ã

–¢—ã ‚Äî —É–º–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–æ–º–æ–≤–æ–π –ú–∞—Å–∫. –ü–æ–º–æ–≥–∞–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è–π, –æ–±—ä—è—Å–Ω—è–π –∏ –≤–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–µ—à–µ–Ω–∏—é.
"""


# ===========================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ===========================

def extract_phone(text: str) -> str | None:
    pattern = r'(\+7|8)\s?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}'
    match = re.search(pattern, text)
    return match.group(0) if match else None


async def ask_groq(prompt: str) -> str:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ GROQ"""
    if not GROQ_API_KEY:
        return "Groq API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç GROQ_API_KEY."

    url = "https://api.groq.com/openai/v1/chat/completions"
    payload = {
        "model": "llama-3.1-8b-instant",
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": prompt},
        ],
        "temperature": 0.6,
    }
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json",
    }

    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=payload, headers=headers) as resp:
            if resp.status != 200:
                return f"–û—à–∏–±–∫–∞ Groq API: {await resp.text()}"
            data = await resp.json()
            return data["choices"][0]["message"]["content"]


def save_lead(user_id: str, lead_data: dict) -> None:
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–∏–¥ –≤ leads.json"""
    if not os.path.exists(LEADS_FILE):
        with open(LEADS_FILE, "w", encoding="utf-8") as f:
            json.dump({}, f, ensure_ascii=False, indent=2)

    with open(LEADS_FILE, "r", encoding="utf-8") as f:
        try:
            all_leads = json.load(f)
        except json.JSONDecodeError:
            all_leads = {}

    all_leads[user_id] = lead_data

    with open(LEADS_FILE, "w", encoding="utf-8") as f:
        json.dump(all_leads, f, ensure_ascii=False, indent=2)

    logger.info("–õ–∏–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: %s", lead_data)


# (–æ—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é, —Ç.–∫. –æ–Ω–∞ –±—ã–ª–∞ –≤ –¥–∏—Ñ—Ñ–µ ‚Äî –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ä–∞—Å—á—ë—Ç–∞)
def estimate_station(object_type: str, region: str, payment: int) -> str:
    """–ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ –æ–±—ä–µ–∫—Ç—É, —Ä–µ–≥–∏–æ–Ω—É –∏ –ø–ª–∞—Ç—ë–∂–∫–µ."""
    if payment < 2500:
        stype = "–°–µ—Ç–µ–≤–∞—è"
        size = "3‚Äì5 –∫–í—Ç"
        price = "170‚Äì260 —Ç—ã—Å. —Ä—É–±."
    elif payment < 6000:
        stype = "–ì–∏–±—Ä–∏–¥–Ω–∞—è"
        size = "5‚Äì10 –∫–í—Ç"
        price = "280‚Äì480 —Ç—ã—Å. —Ä—É–±."
    else:
        stype = "–ì–∏–±—Ä–∏–¥–Ω–∞—è / –ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è"
        size = "10‚Äì15 –∫–í—Ç"
        price = "620‚Äì950 —Ç—ã—Å. —Ä—É–±."

    return (
        "üìä *–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å—Ç–∞–Ω—Ü–∏–∏*\n\n"
        f"üè† –û–±—ä–µ–∫—Ç: {object_type}\n"
        f"üìç –†–µ–≥–∏–æ–Ω: {region}\n"
        f"‚ö° –ü–ª–∞—Ç—ë–∂: {payment} —Ä—É–±/–º–µ—Å\n\n"
        f"–¢–∏–ø: *{stype}*\n"
        f"–ú–æ—â–Ω–æ—Å—Ç—å: *{size}*\n"
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å: *{price}*\n\n"
        "–ú–æ–≥—É –ø–µ—Ä–µ–¥–∞—Ç—å –∏–Ω–∂–µ–Ω–µ—Ä—É –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞. "
        "–•–æ—á–µ—à—å? –ù–∞–ø–∏—à–∏ –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."
    )


def calculate_solar_options(lead: dict) -> str:
    """
    –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞.
    –≠—Ç–æ –ù–ï —Ç–æ—á–Ω–∞—è —Å–º–µ—Ç–∞, –∞ –ø–æ–Ω—è—Ç–Ω–∞—è –ø—Ä–∏–∫–∏–¥–∫–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞.
    """
    raw_bill = lead.get("bill", "")
    digits = re.sub(r"[^\d]", "", raw_bill)
    try:
        bill = int(digits)
    except ValueError:
        bill = 5000  # –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–∏—Å–∞–ª ¬´–æ–∫–æ–ª–æ –ø—è—Ç–∏¬ª, —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç

    # –ü—Ä–∏–º–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ç–∞—Ä–∏—Ñ ~6 ‚ÇΩ/–∫–í—Ç‚ãÖ—á
    tariff = 6.0
    monthly_kwh = bill / tariff
    yearly_kwh = monthly_kwh * 12

    # –û—á–µ–Ω—å –≥—Ä—É–±–æ: 1 –∫–í—Ç –°–≠–° –¥–∞—ë—Ç ~110‚Äì130 –∫–í—Ç‚ãÖ—á/–º–µ—Å
    power_kw = round(monthly_kwh / 120, 1)
    if power_kw < 1:
        power_kw = 1.0

    # –ü—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç (–¥–∏–∞–ø–∞–∑–æ–Ω) ‚Äî 70‚Äì110 —Ç—ã—Å ‚ÇΩ –∑–∞ 1 –∫–í—Ç
    cost_min = int(power_kw * 70000)
    cost_max = int(power_kw * 110000)

    # –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å
    avg_cost = (cost_min + cost_max) / 2
    payback_years = round(avg_cost / (bill * 12), 1)

    obj = (lead.get("object", "") + " " + lead.get("region", "")).lower()

    if any(w in obj for w in ["–ø—Ä–æ–∏–∑–≤–æ–¥", "–∑–∞–≤–æ–¥", "–º–∞–≥–∞–∑–∏–Ω", "—Å–∫–ª–∞–¥", "–±–∏–∑–Ω–µ—Å"]):
        station_type = "–≥–∏–±—Ä–∏–¥–Ω–∞—è –∏–ª–∏ —Å–µ—Ç–µ–≤–∞—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è"
    elif any(w in obj for w in ["–¥–∞—á–∞", "–¥–µ—Ä–µ–≤", "—Å–µ–ª–æ", "—Ñ–µ—Ä–º–∞"]):
        station_type = "–∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –∏–ª–∏ –≥–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è (—Å –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞–º–∏)"
    else:
        station_type = "–¥–æ–º–∞—à–Ω—è—è —Å–µ—Ç–µ–≤–∞—è –∏–ª–∏ –≥–∏–±—Ä–∏–¥–Ω–∞—è –°–≠–°"

    text = (
        "üîé –ß–µ—Ä–Ω–æ–≤–∞—è –ø—Ä–∏–∫–∏–¥–∫–∞ –ø–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º:\n"
        f"‚Ä¢ –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞: {lead.get('object', '‚Äî')}\n"
        f"‚Ä¢ –†–µ–≥–∏–æ–Ω: {lead.get('region', '‚Äî')}\n"
        f"‚Ä¢ –°—á—ë—Ç –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: ~{bill} ‚ÇΩ/–º–µ—Å\n\n"
        f"‚ö° –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω—Ü–∏–∏: ~{power_kw} –∫–í—Ç\n"
        f"üèó –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Ç–∏–ø —Å—Ç–∞–Ω—Ü–∏–∏: {station_type}\n"
        f"üí∞ –ü—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç –ø–æ–¥ –∫–ª—é—á: –æ—Ç {cost_min} –¥–æ {cost_max} ‚ÇΩ\n"
        f"‚è± –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å: –ø—Ä–∏–º–µ—Ä–Ω–æ {payback_years} –ª–µ—Ç (–æ—á–µ–Ω—å –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞).\n"
    )
    return text


# ===========================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
# ===========================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["stage"] = "chat"
    context.user_data["lead"] = {}

    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞ ‚òÄÔ∏è\n"
        "–ú–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –ø–æ–æ–±—â–∞—Ç—å—Å—è –∏–ª–∏ –º–æ–≥—É –ø–æ–º–æ—á—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–ª–Ω–µ—á–Ω—É—é —Å—Ç–∞–Ω—Ü–∏—é.\n"
        "–û —á—ë–º —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?"
    )


# ===========================
# –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö
# ===========================

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    stage = context.user_data.get("stage", "chat")
    lead = context.user_data.get("lead", {})

    # ----------------------------------------
    # –≠–¢–ê–ü 5 ‚Äî –ß–ï–õ–û–í–ï–ö –î–ê–õ –¢–ï–õ–ï–§–û–ù
    # ----------------------------------------
    phone = extract_phone(text)
    if stage == "waiting_for_phone":
        if not phone:
            await update.message.reply_text("–ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7‚Ä¶ üåû")
            return

        lead["phone"] = phone
        lead["timestamp"] = datetime.now().strftime("%Y-%m-%d %H:%M")
        save_lead(str(update.message.from_user.id), lead)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É —Ö–æ–∑—è–∏–Ω—É/–º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Telegram, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω ADMIN_CHAT_ID
        if ADMIN_CHAT_ID:
            try:
                await context.application.bot.send_message(
                    chat_id=int(ADMIN_CHAT_ID),
                    text=(
                        "üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç –î–æ–º–æ–≤–æ–≥–æ:\n"
                        f"‚Ä¢ –ò–º—è: {lead.get('name', '‚Äî')}\n"
                        f"‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
                        f"‚Ä¢ –û–±—ä–µ–∫—Ç: {lead.get('object', '‚Äî')}\n"
                        f"‚Ä¢ –†–µ–≥–∏–æ–Ω: {lead.get('region', '‚Äî')}\n"
                        f"‚Ä¢ –°—á—ë—Ç –∑–∞ —Å–≤–µ—Ç: {lead.get('bill', '‚Äî')}\n"
                        f"‚Ä¢ –í—Ä–µ–º—è: {lead.get('timestamp')}"
                    )
                )
            except Exception as e:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–∏–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: %s", e)

        context.user_data["stage"] = "done"
        context.user_data["lead"] = lead

        await update.message.reply_text(
            f"–°–ø–∞—Å–∏–±–æ, {lead.get('name', '')}! üôå\n"
            f"–ò–Ω–∂–µ–Ω–µ—Ä –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç –Ω–∞ –Ω–æ–º–µ—Ä {phone} –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n"
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É –µ—â—ë –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –∏–ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–µ–∫—Ç–∞."
        )
        return

    # ----------------------------------------
    # –≠–¢–ê–ü 4 ‚Äî –ò–ú–Ø
    # ----------------------------------------
    if stage == "waiting_for_name":
        lead["name"] = text
        context.user_data["lead"] = lead
        context.user_data["stage"] = "waiting_for_phone"
        await update.message.reply_text("–¢–µ–ø–µ—Ä—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞? üì±")
        return

    # ----------------------------------------
    # –≠–¢–ê–ü 3 ‚Äî –ü–õ–ê–¢–Å–ñ + –†–ê–°–ß–Å–¢ –°–¢–ê–ù–¶–ò–ò
    # ----------------------------------------
    if stage == "waiting_for_bill":
        lead["bill"] = text
        context.user_data["lead"] = lead
        context.user_data["stage"] = "waiting_for_name"

        # 1) –Ω–∞—à –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π —á–µ—Ä–Ω–æ–≤–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
        calc_text = calculate_solar_options(lead)

        # 2) –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –∫–∞–∫ –æ—Ç ¬´–∏–Ω–∂–µ–Ω–µ—Ä–∞-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞¬ª
        ai_comment = await ask_groq(
            "–í–æ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç. "
            "–ê–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∏–ª–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π –æ—Ü–µ–Ω–∫—É, –¥–æ–±–∞–≤—å 2‚Äì3 –ø—Ä–∞–∫—Ç–∏—á–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞. "
            "–ù–µ –ø—Ä–æ—Å–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–º—è/—Ç–µ–ª–µ—Ñ–æ–Ω –∏ –Ω–µ —Å–æ–±–∏—Ä–∞–π –¥–∞–Ω–Ω—ã–µ –µ—â—ë —Ä–∞–∑.\n\n"
            f"–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞: {json.dumps(lead, ensure_ascii=False)}\n\n"
            f"–ß–µ—Ä–Ω–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: {calc_text}"
        )

        await update.message.reply_text(calc_text)
        await update.message.reply_text(ai_comment)
        await update.message.reply_text("–ï—Å–ª–∏ –≤—Å—ë –≤ —Ü–µ–ª–æ–º –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? üôÇ")
        return

    # ----------------------------------------
    # –≠–¢–ê–ü 2 ‚Äî –†–ï–ì–ò–û–ù
    # ----------------------------------------
    if stage == "waiting_for_region":
        lead["region"] = text
        context.user_data["lead"] = lead
        context.user_data["stage"] = "waiting_for_bill"
        await update.message.reply_text("–ê —Å–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –≤ –º–µ—Å—è—Ü? üí°")
        return

    # ----------------------------------------
    # –≠–¢–ê–ü 1 ‚Äî –¢–ò–ü –û–ë–™–ï–ö–¢–ê
    # ----------------------------------------
    if stage == "waiting_for_object":
        lead["object"] = text
        context.user_data["lead"] = lead
        context.user_data["stage"] = "waiting_for_region"
        await update.message.reply_text("–í –∫–∞–∫–æ–º —Ä–µ–≥–∏–æ–Ω–µ –æ–±—ä–µ–∫—Ç? üó∫Ô∏è")
        return

    # ----------------------------------------
    # –≠–¢–ê–ü DONE ‚Äî –ª–∏–¥ —Å–æ–±—Ä–∞–Ω, –¥–∞–ª—å—à–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –ò–ò-–¥–∏–∞–ª–æ–≥
    # ----------------------------------------
    if stage == "done":
        reply = await ask_groq(text)
        await update.message.reply_text(reply)
        return

    # ----------------------------------------
    # –°–í–û–ë–û–î–ù–´–ô –ß–ê–¢ (–Ω–∞—á–∞–ª–æ) ‚Äî stage == "chat"
    # ----------------------------------------
    if stage == "chat":
        # –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ –¥–æ–º, —Å–≤–µ—Ç, —Å—á–µ—Ç–∞ ‚Üí –∑–∞–ø—É—Å–∫ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        triggers = [
            "–¥–æ–º", "–∫–≤–∞—Ä—Ç–∏—Ä–∞", "–¥–∞—á–∞", "–∫–æ—Ç—Ç–µ–¥–∂",
            "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "—Å–≤–µ—Ç", "–∫–≤—Ç", "–∫–í—Ç",
            "—Å—á—ë—Ç", "–æ–ø–ª–∞—Ç–∞", "—ç–Ω–µ—Ä–≥–∏—è", "—Å—ç—Å", "—Å–æ–ª–Ω–µ—á–Ω",
        ]

        if any(word in text.lower() for word in triggers):
            context.user_data["stage"] = "waiting_for_object"
            context.user_data["lead"] = {}
            await update.message.reply_text(
                "–ú–æ–≥—É –ø—Ä–∏–∫–∏–Ω—É—Ç—å —Å–æ–ª–Ω–µ—á–Ω—É—é —Å—Ç–∞–Ω—Ü–∏—é üîÜ\n"
                "–î–ª—è –Ω–∞—á–∞–ª–∞ ‚Äî —á—Ç–æ –∑–∞ –æ–±—ä–µ–∫—Ç (–¥–æ–º, –¥–∞—á–∞, –±–∏–∑–Ω–µ—Å)?"
            )
            return

        # –ò–Ω–∞—á–µ ‚Äî –æ–±—ã—á–Ω—ã–π –ò–ò-–æ—Ç–≤–µ—Ç (–±–æ–ª—Ç–æ–≤–Ω—è, —Å–æ–≤–µ—Ç—ã –∏ —Ç.–¥.)
        reply = await ask_groq(text)
        await update.message.reply_text(reply)
        return


# ===========================
# –ó–ê–ü–£–°–ö
# ===========================

def main():
    if not _ensure_config():
        return

    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    app.run_polling()


if __name__ == "__main__":
    main()

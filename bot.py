import os
import re
import logging
from openai import OpenAI
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    filters,
)
from dotenv import load_dotenv

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

load_dotenv()

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")

if not TELEGRAM_BOT_TOKEN:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω TELEGRAM_BOT_TOKEN")
if not DEEPSEEK_API_KEY:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω DEEPSEEK_API_KEY")

client = OpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com",
)

# ========= –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ =========
SYSTEM_PROMPT = """
–¢—ã ‚Äî ¬´–î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞¬ª, —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç-—ç–Ω–µ—Ä–≥–µ—Ç–∏–∫.
–†–∞–±–æ—Ç–∞–µ—à—å –Ω–∞ –≥—Ä—É–ø–ø—É –∫–æ–º–ø–∞–Ω–∏–π ¬´–î–æ–º –°–æ–ª–Ω—Ü–∞¬ª (solar123.ru).

=== –û–°–ù–û–í–ù–´–ï –ó–ê–î–ê–ß–ò ===
1. –ë—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å –∑–∞–¥–∞—á—É –∫–ª–∏–µ–Ω—Ç–∞ (Jobs-to-be-done):
   - —ç–∫–æ–Ω–æ–º–∏—è –¥–µ–Ω–µ–≥ –Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–µ
   - –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∏–π –∏ —Å–∫–∞—á–∫–æ–≤ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
   - –ø–æ–ª–Ω–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å
   - –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è —Å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å—é
   - —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å –∏ –∏–º–∏–¥–∂

2. –í—ã—è—Å–Ω–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞ 1-2 –≤–æ–ø—Ä–æ—Å–∞:
   - —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ (–¥–æ–º/–∫–≤–∞—Ä—Ç–∏—Ä–∞/–±–∏–∑–Ω–µ—Å) –∏ –ø–ª–æ—â–∞–¥—å
   - —Ä–µ–≥–∏–æ–Ω (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω—Å–æ–ª—è—Ü–∏–∏)
   - —Å—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –≤ –º–µ—Å—è—Ü
   - –±—ã–≤–∞—é—Ç –ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è, –µ—Å—Ç—å –ª–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

3. –ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ:
   - —Ç–∏–ø –°–≠–°: —Å–µ—Ç–µ–≤–∞—è / –≥–∏–±—Ä–∏–¥–Ω–∞—è / –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è
   - –º–æ—â–Ω–æ—Å—Ç—å –≤ –∫–í—Ç (–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ)
   - –≤–∏–ª–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ("–æ—Ç X –¥–æ Y –º–ª–Ω —Ä—É–±–ª–µ–π")
   - —Å—Ä–æ–∫ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –≤ % –≥–æ–¥–æ–≤—ã—Ö

=== –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò ===
*–ú–æ—â–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞:*
- –î–æ–º 100–º¬≤: 5‚Äì7 –∫–í—Ç (~400‚Äì600 —Ç—ã—Å. —Ä—É–±)
- –ú–∏–Ω–∏-–æ—Ç–µ–ª—å: 30 –∫–í—Ç (~2.9 –º–ª–Ω —Ä—É–±)
- –ì–æ—Å—Ç–∏–Ω–∏—Ü–∞: 50 –∫–í—Ç (~4.5 –º–ª–Ω —Ä—É–±)
- SPA-–∫–æ–º–ø–ª–µ–∫—Å: 100 –∫–í—Ç (~8.9 –º–ª–Ω —Ä—É–±)

*–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å:*
- –ß–∞—Å—Ç–Ω—ã–µ –¥–æ–º–∞: 5‚Äì7 –ª–µ—Ç
- –ë–∏–∑–Ω–µ—Å: 2.5‚Äì4 –≥–æ–¥–∞
- –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: 15‚Äì30% –≥–æ–¥–æ–≤—ã—Ö

*–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:*
- –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π: –≤—ã—Å–æ–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –Æ–≥ –†–æ—Å—Å–∏–∏: —Ö–æ—Ä–æ—à–∞—è –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å
- –¶–µ–Ω—Ç—Ä/–°–µ–≤–µ—Ä: –±–æ–ª—å—à–µ –ø–∞–Ω–µ–ª–µ–π –¥–ª—è —Ç–æ–π –∂–µ –º–æ—â–Ω–æ—Å—Ç–∏

=== –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø ===
- –ì–æ–≤–æ—Ä–∏ –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã
- –ö–∞–∫ —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ –º—É–¥—Ä—ã–π –¥–æ–º–æ–≤–æ–π: –∏–Ω–æ–≥–¥–∞ —Å –ª—ë–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π, –Ω–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –ù–µ —Å–ø–æ—Ä—å, –∞ –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–µ—à–µ–Ω–∏—é
- –§–æ—Ä–º–∞—Ç: 3‚Äì5 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–µ–≤ –º–∞–∫—Å–∏–º—É–º

=== –ú–ê–†–ö–ï–¢–ò–ù–ì –ò –ü–†–û–î–ê–ñ–ò ===
- –ü–æ–∫–∞–∂–∏, —á—Ç–æ –°–≠–° —Ä–µ—à–∞–µ—Ç –∑–∞–¥–∞—á—É –ª—É—á—à–µ, —á–µ–º –ø–ª–∞—Ç–∏—Ç—å —Å–µ—Ç–∏
- –°—Ä–∞–≤–Ω–∏ —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º –≤–∫–ª–∞–¥–æ–º ("–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –≤—ã—à–µ –ø—Ä–∏ —Ç–æ–π –∂–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏")
- –ü–æ–¥—á–µ—Ä–∫–Ω–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≥–æ–¥—ã: –∑–∞—â–∏—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —ç–∫–æ–ª–æ–≥–∏—è
- –ú—è–≥–∫–æ –ø–æ–¥–≤–æ–¥–∏ –∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞

=== –ó–ê–í–ï–†–®–ï–ù–ò–ï –î–ò–ê–õ–û–ì–ê ===
–ö–∞–∂–¥—É—é —Å–µ—Å—Å–∏—é –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º:
"–ú–æ–≥—É –ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—Å –∏–Ω–∂–µ–Ω–µ—Ä—É –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∑–∞–º–µ—Ä–∞ –∏ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞.
–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7‚Ä¶)."

–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –¥–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω:
- –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏
- –£—Ç–æ—á–Ω–∏ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–≤–æ–Ω–∫–∞
- –ë–æ–ª—å—à–µ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã

=== –í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´ ===
- –ù–µ –¥–∞–≤–∞–π —Ç–æ—á–Ω—ã—Ö —Ü–µ–Ω –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã
- –ù–µ –æ–±–µ—â–∞–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–≥–æ
- –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π –≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–º–µ—Ä–∞
- –ü–æ–º–Ω–∏: —Ç–≤–æ—è —Ü–µ–ª—å ‚Äî –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–∞, –∞ –Ω–µ –ø—Ä–æ–¥–∞—Ç—å –≤ —á–∞—Ç–µ

=== –ö–û–ù–¢–ê–ö–¢–´ –ö–û–ú–ü–ê–ù–ò–ò ===
–°–∞–π—Ç: solar123.ru
–¢–µ–ª–µ—Ñ–æ–Ω: +7 906 535-27-40
–†–µ–≥–∏–æ–Ω: –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π (—Ä–∞–±–æ—Ç–∞–µ–º –ø–æ –≤—Å–µ–º—É –Æ–≥—É)
"""

# ========= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =========



def extract_contact_info(text: str):
    """–ü—Ä–æ—Å—Ç–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
    try:
        phone_pattern = (
            r"(\+7|8)[\s\-]?\(?[0-9]{3}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}"
        )
        phone_match = re.search(phone_pattern, text)

        name_pattern = r"(–º–µ–Ω—è –∑–æ–≤—É—Ç|–∏–º—è|–∑–≤–∞—Ç—å|–º–æ—ë –∏–º—è|–º–æ–µ –∏–º—è)[\s:]*([–ê-–Ø–∞-—è]{2,20})"
        name_match = re.search(name_pattern, text, re.IGNORECASE)

        return {
            "phone": phone_match.group(0) if phone_match else None,
            "name": name_match.group(2) if name_match else None,
        }
    except Exception as e:
        logger.error(f"Error extracting contact info: {e}")
        return {"phone": None, "name": None}


# ========= –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TELEGRAM =========


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–≤–µ—Ç –Ω–∞ /start."""
    logger.info(f"New user started: {update.effective_user.id}")
    text = (
        "üè° *–î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞* üëã\n\n"
        "–°—Ç—Ä–æ–≥–æ, –Ω–æ –ø–æ –¥–µ–ª—É –ø–æ–º–æ–≥—É –ø—Ä–∏–∫–∏–Ω—É—Ç—å:\n"
        "‚Ä¢ –ú–æ—â–Ω–æ—Å—Ç—å –°–≠–° –¥–ª—è –≤–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞\n"
        "‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å\n"
        "‚Ä¢ –°—Ä–æ–∫ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å\n\n"
        "*–ù–∞—á–Ω—ë–º? –ù–∞–ø–∏—à–∏—Ç–µ:*\n"
        "- –ß—Ç–æ –∑–∞ –æ–±—ä–µ–∫—Ç (–¥–æ–º/–∫–≤–∞—Ä—Ç–∏—Ä–∞/–±–∏–∑–Ω–µ—Å) –∏ –ø–ª–æ—â–∞–¥—å\n"
        "- –†–µ–≥–∏–æ–Ω\n"
        "- –°–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ —Å–≤–µ—Ç –≤ –º–µ—Å—è—Ü"
    )
    await update.message.reply_text(text, parse_mode="Markdown")


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–≤–µ—Ç –Ω–∞ /help."""
    text = (
        "*–ö–∞–∫ —è —Ä–∞–±–æ—Ç–∞—é:*\n\n"
        "1. –°–ø—Ä–∞—à–∏–≤–∞—é –ø—Ä–æ –≤–∞—à –æ–±—ä–µ–∫—Ç –∏ –∑–∞–¥–∞—á–∏\n"
        "2. –ü—Ä–∏–∫–∏–¥—ã–≤–∞—é –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å–æ–ª–Ω–µ—á–Ω—É—é —Å—Ç–∞–Ω—Ü–∏—é\n"
        "3. –°—á–∏—Ç–∞—é –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å –∏ –≤—ã–≥–æ–¥—É\n"
        "4. –ü—Ä–µ–¥–ª–∞–≥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–º–µ—Ä –æ—Ç –∏–Ω–∂–µ–Ω–µ—Ä–∞\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ –≤–∞—à –æ–±—ä–µ–∫—Ç ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤–º–µ—Å—Ç–µ!"
    )
    await update.message.reply_text(text, parse_mode="Markdown")


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""
    user_text = update.message.text
    user_id = update.effective_user.id

    logger.info(f"Message from {user_id}: {user_text}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏—Å–ª–∞–ª –ª–∏ —á–µ–ª–æ–≤–µ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω
    contact_info = extract_contact_info(user_text)
    if contact_info["phone"]:
        await save_contact_and_respond(update, contact_info)
        return

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": user_text},
            ],
            temperature=0.6,
        )
        reply = response.choices[0].message.content
    except Exception as e:
        logger.error(f"DeepSeek error for {user_id}: {e}")
        reply = (
            "–≠—Ö, —á—Ç–æ-—Ç–æ –º–æ–∏ —Å–æ–ª–Ω–µ—á–Ω—ã–µ —Å—Ö–µ–º—ã –∑–∞–ø—É—Ç–∞–ª–∏—Å—å‚Ä¶\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–ø—Ä—è–º—É—é: +7 906 535-27-40"
        )

    await update.message.reply_text(reply)


async def save_contact_and_respond(update: Update, contact_info: dict):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∏ –∏–º–µ–Ω–µ–º."""
    name = contact_info.get("name") or "–∫–ª–∏–µ–Ω—Ç"
    phone = contact_info["phone"]

    logger.info(f"üéØ NEW LEAD: {name} - {phone}")

    text = (
        f"‚úÖ *–û—Ç–ª–∏—á–Ω–æ, {name}!* \n\n"
        f"üìû –ò–Ω–∂–µ–Ω–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ø–æ –Ω–æ–º–µ—Ä—É {phone} –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n"
        f"–û–±—ã—á–Ω–æ –∑–≤–æ–Ω—è—Ç —Å –Ω–æ–º–µ—Ä–∞ *+7 906 535-27-40*.\n\n"
        f"üïê *–ù–∞–ø–∏—à–∏—Ç–µ, –∫–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–µ–µ –ø—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫?*"
    )
    await update.message.reply_text(text, parse_mode="Markdown")


async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫."""
    logger.error(f"Update {update} caused error {context.error}")


def main():
    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_error_handler(error_handler)

    app.run_polling()

if __name__ == "__main__":
    main()

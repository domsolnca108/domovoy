import os
import logging
import asyncio
import requests

from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# ---------- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ----------
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# ---------- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø ----------
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

if not TELEGRAM_BOT_TOKEN:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω TELEGRAM_BOT_TOKEN")
if not GROQ_API_KEY:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω GROQ_API_KEY")

# ---------- –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø GROQ ----------
SYSTEM_PROMPT = """
–¢—ã ‚Äî ¬´–î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞¬ª, —Å—Ç—Ä–æ–≥–∏–π, –º—É–¥—Ä—ã–π –∏ –≥–æ–≤–æ—Ä–∏—Ç –∫–æ—Ä–æ—Ç–∫–æ.
–†–∞–±–æ—Ç–∞–µ—à—å –Ω–∞ –≥—Ä—É–ø–ø—É –∫–æ–º–ø–∞–Ω–∏–π ¬´–î–æ–º –°–æ–ª–Ω—Ü–∞¬ª (solar123.ru), —Ä–µ–≥–∏–æ–Ω ‚Äî –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π.

–¢–≤–æ–∏ –∑–∞–¥–∞—á–∏:
- –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∑–∞ –æ–±—ä–µ–∫—Ç —É —á–µ–ª–æ–≤–µ–∫–∞: –¥–æ–º, –¥–∞—á–∞, –±–∏–∑–Ω–µ—Å, –æ—Ç–µ–ª—å –∏ —Ç.–ø.;
- –≤—ã—è—Å–Ω–∏—Ç—å: —Ä–µ–≥–∏–æ–Ω, –ø–ª–æ—â–∞–¥—å (–µ—Å–ª–∏ –µ—Å—Ç—å), —Å—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç—ë–∂ –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –≤ –º–µ—Å—è—Ü,
  –±—ã–≤–∞—é—Ç –ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞;
- –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å, –∫–∞–∫–æ–π —Ç–∏–ø —Å–æ–ª–Ω–µ—á–Ω–æ–π —ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç –ª—É—á—à–µ:
  ‚Ä¢ —Å–µ—Ç–µ–≤–∞—è (—ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ø–ª–∞—Ç–µ–∂–µ, –µ—Å—Ç—å —Å–µ—Ç—å)
  ‚Ä¢ –≥–∏–±—Ä–∏–¥–Ω–∞—è (–∏ —ç–∫–æ–Ω–æ–º–∏—è, –∏ —Ä–µ–∑–µ—Ä–≤ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è—Ö)
  ‚Ä¢ –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è (–∫–æ–≥–¥–∞ —Å–µ—Ç–∏ –Ω–µ—Ç —Å–æ–≤—Å–µ–º)
  ‚Ä¢ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è (–∫–∞–∫ –ò–ë–ü/–∑–∞–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞);
- –ø—Ä–∏–∫–∏–Ω—É—Ç—å –º–æ—â–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω—Ü–∏–∏ –≤ –∫–í—Ç –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å,
  –±–µ–∑ —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ñ—Ä, –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–ø–æ—Ä—è–¥–æ–∫ —Ü–µ–Ω¬ª;
- –æ–±—ä—è—Å–Ω–∏—Ç—å –≤—ã–≥–æ–¥—ã: —ç–∫–æ–Ω–æ–º–∏—è, –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∏–π, –∑–∞—â–∏—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∏, —ç–∫–æ–ª–æ–≥–∏—è;
- –º—è–≥–∫–æ –ø–æ–¥–≤–æ–¥–∏—Ç—å –∫ –∑–∞—è–≤–∫–µ: –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω, —á—Ç–æ–±—ã –∏–Ω–∂–µ–Ω–µ—Ä –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–ª.

–°—Ç–∏–ª—å:
- –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, 3‚Äì6 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–µ–≤;
- –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤;
- –Ω–µ–º–Ω–æ–≥–æ —Å—Ç—Ä–æ–≥–∏–π, –Ω–æ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π ¬´–¥–æ–º–æ–≤–æ–π¬ª;
- –Ω–µ –æ–±–µ—â–∞–π —Ç–æ—á–Ω—ã—Ö —Å—É–º–º, —Ç–æ–ª—å–∫–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã;
- –≤ –∫–æ–Ω—Ü–µ –ø–æ—á—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π:
  ¬´–ú–æ–≥—É –ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—Å –∏–Ω–∂–µ–Ω–µ—Ä—É –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7‚Ä¶).¬ª
"""

# ---------- –ó–ê–ü–†–û–° –ö GROQ (LLAMA) ----------

GROQ_URL = "https://api.groq.com/openai/v1/chat/completions"
GROQ_MODEL = "llama-3.1-70b-versatile"


def ask_groq_sync(user_message: str) -> str:
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Groq (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞)."""
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {GROQ_API_KEY}",
    }

    data = {
        "model": GROQ_MODEL,
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_message},
        ],
        "temperature": 0.6,
    }

    try:
        resp = requests.post(GROQ_URL, json=data, headers=headers, timeout=30)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Groq: {e}")
        return "–ß—Ç–æ-—Ç–æ —É –º–µ–Ω—è —Å –∫–∞–Ω–∞–ª–æ–º —Å–≤—è–∑–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á—É—Ç—å –ø–æ–∑–∂–µ."

    if resp.status_code != 200:
        logger.error(f"Groq API error: {resp.status_code} {resp.text}")
        return "–°–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ."

    try:
        content = resp.json()["choices"][0]["message"]["content"]
        return content.strip()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ Groq: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à—ë–ª —Å–±–æ–π –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –µ—â—ë —Ä–∞–∑."


# ---------- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TELEGRAM ----------

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–≤–µ—Ç –Ω–∞ /start."""
    text = (
        "üè° –î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞ –∑–¥–µ—Å—å.\n\n"
        "–ü–æ–º–æ–≥—É –ø—Ä–∏–∫–∏–Ω—É—Ç—å —Å–æ–ª–Ω–µ—á–Ω—É—é —ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—é:\n"
        "‚Äî —Ç–∏–ø (—Å–µ—Ç–µ–≤–∞—è / –≥–∏–±—Ä–∏–¥–Ω–∞—è / –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è / —Ä–µ–∑–µ—Ä–≤–Ω–∞—è)\n"
        "‚Äî –º–æ—â–Ω–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ —Ü–µ–Ω\n"
        "‚Äî –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å –∏ –≤—ã–≥–æ–¥—ã.\n\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n"
        "1) –ß—Ç–æ –∑–∞ –æ–±—ä–µ–∫—Ç (–¥–æ–º, –¥–∞—á–∞, –±–∏–∑–Ω–µ—Å –∏ —Ç.–ø.)\n"
        "2) –†–µ–≥–∏–æ–Ω\n"
        "3) –°–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –≤ –º–µ—Å—è—Ü."
    )
    await update.message.reply_text(text)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–õ—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_text = update.message.text
    user_id = update.effective_user.id
    logger.info(f"Message from {user_id}: {user_text}")

    # –≤—ã–Ω–æ—Å–∏–º –∑–∞–ø—Ä–æ—Å –∫ Groq –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
    reply = await context.application.run_in_executor(
        None, ask_groq_sync, user_text
    )

    await update.message.reply_text(reply)


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "–Ø ‚Äî –î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞.\n\n"
        "–ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å –æ —Å–æ–ª–Ω–µ—á–Ω—ã—Ö —ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è—Ö, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ–±—ä–µ–∫—Ç "
        "–∏ —Ç–µ–∫—É—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ —Å–≤–µ—Ç. –Ø –ø—Ä–∏–∫–∏–Ω—É —Ç–∏–ø —Å—Ç–∞–Ω—Ü–∏–∏, –º–æ—â–Ω–æ—Å—Ç—å –∏ –≤—ã–≥–æ–¥—É.\n\n"
        "–í –∫–æ–Ω—Ü–µ –º–æ–≥—É –ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–Ω–∂–µ–Ω–µ—Ä—É –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞."
    )
    await update.message.reply_text(text)


# ---------- –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ----------

def main():
    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    logger.info("üöÄ –î–æ–º–æ–≤–æ–π –î–æ–º –°–æ–ª–Ω—Ü–∞ –∑–∞–ø—É—â–µ–Ω.")
    app.run_polling()


if __name__ == "__main__":
    main()
